services:
  db:
    # PostgreSQL 17-alpine: floating tag pulls latest patch version (e.g., 17.2, 17.3...)
    # Automatic patch updates on container restart, manual major version upgrades
    image: postgres:17-alpine 
    container_name: forgejo-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: forgejo
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: forgejo
    volumes:
      - ./db_data:/var/lib/postgresql/data
    networks:
      - forgejo-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U forgejo"]
      interval: 10s
      timeout: 5s
      retries: 5

  forgejo:
    # Forgejo 13-rootless: floating tag pulls latest patch in v13 branch (e.g., 13.0.3, 13.1.0...)
    # Automatic patch updates on container restart, manual major version upgrades
    image: codeberg.org/forgejo/forgejo:13-rootless
    container_name: forgejo-app
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      USER_UID: 1000
      USER_GID: 1000
      FORGEJO__database__DB_TYPE: postgres
      FORGEJO__database__HOST: db:5432
      FORGEJO__database__NAME: forgejo
      FORGEJO__database__USER: forgejo
      FORGEJO__database__PASSWD: ${DB_PASSWORD}
      FORGEJO__server__DOMAIN: {{ container_ip }}
      FORGEJO__server__ROOT_URL: https://{{ container_ip }}/
      FORGEJO__server__SSH_DOMAIN: {{ container_ip }}
      FORGEJO__server__SSH_PORT: 22
      FORGEJO__server__SSH_LISTEN_PORT: 22
      FORGEJO__repository__USE_COMPAT_SSH_URI: false
    volumes:
      - ./app_data:/var/lib/gitea
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "127.0.0.1:3000:3000"   # Web UI (proxied by nginx)
      - "22:22"                 # Git SSH
    networks:
      - forgejo-net

networks:
  forgejo-net:
    driver: bridge